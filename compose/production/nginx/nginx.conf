worker_processes  1;

events {
    worker_connections  25000;
}

http {
    include mime.types;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;

    server_tokens off;

    upstream django {
      ip_hash;
      server django:8000;
    }
    upstream minio {
      ip_hash;
      server minio:9000;
    }

    ###############频率控制#######################
    geo $limit {
      default 1;
      127.0.0.1 0;     # 本机地址
    }

    map $limit $limit_key {
      0 "";
      1 $binary_remote_addr;
    }

    limit_req_zone $limit_key zone=one:2m rate=10r/s;
    sendfile        on;
    keepalive_timeout  65;

    server {
        listen       80;
        server_name  api.afanchat.cn minio.afanchat.cn www.afanchat.cn;
        #将请求转成https
        rewrite ^(.*)$ https://$host$1 permanent;
        charset utf-8;
    }

    #对象存储专用
    server {
        listen       443 ssl;
        server_name  minio.afanchat.cn;
        #频率控制
        limit_req zone=one burst=10 nodelay;

        ssl_certificate /usr/share/nginx/ssl/afanchat.cn.pem;
        ssl_certificate_key /usr/share/nginx/ssl/afanchat.cn.key;

        ssl_session_cache shared:SSL:1m;
        ssl_session_timeout 5m;
        location / {
            proxy_pass http://minio;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP  $remote_addr;
            proxy_set_header X-Nginx-Proxy true;
            client_body_buffer_size 10M;
            client_max_body_size 10G;
            proxy_buffers 1024 4k;
        }
    }
    server {
        listen       443 ssl;
        server_name  www.afanchat.cn;
        #频率控制
        limit_req zone=one burst=10 nodelay;

        ssl_certificate /usr/share/nginx/ssl/afanchat.cn.pem;
        ssl_certificate_key /usr/share/nginx/ssl/afanchat.cn.key;

        ssl_session_cache shared:SSL:1m;
        ssl_session_timeout 5m;
        location / {
          root /usr/share/nginx/html/www/wwwroot/www.afanchat.cn;
          index index.html;
          try_files $uri $uri/ /index.html;
        }
    }
    server {
        listen       443 ssl;
        server_name  api.afanchat.cn;
        #频率控制
        limit_req zone=one burst=10 nodelay;

        ssl_certificate /usr/share/nginx/ssl/afanchat.cn.pem;
        ssl_certificate_key /usr/share/nginx/ssl/afanchat.cn.key;

        ssl_session_cache shared:SSL:1m;
        ssl_session_timeout 5m;
        location / {
            proxy_set_header X-Real-IP  $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Host $http_host;
            proxy_set_header X-Nginx-Proxy true;
            proxy_set_header Connection "";
            proxy_pass http://django;
            proxy_redirect default;

            proxy_hide_header Access-Control-Allow-Origin;
            add_header 'Access-Control-Allow-Origin' 'https://www.afanchat.cn';
            add_header 'Access-Control-Allow-Headers' '*';
            add_header 'Access-Control-Allow-Methods' '*';

            # OPTIONS 直接返回204
            if ($request_method = 'OPTIONS') {
               return 204;
            }
            location = /MP_verify_GTPosqCvKIDnld6z.txt {
                    alias  /usr/share/nginx/html/MP_verify_GTPosqCvKIDnld6z.txt;
            }
            error_page   500 502 503 504  /50x.html;
            location = /50x.html {
              root   html;
            }
        }

        location /websocket {
            proxy_pass http://django;
            proxy_redirect off;

            proxy_http_version 1.1;

            proxy_set_header Host  $host;
            proxy_set_header X-Real-Ip $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Nginx-Proxy true;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            client_max_body_size 10m;

            proxy_connect_timeout 600s;
            proxy_read_timeout 600s;
            proxy_send_timeout 600s;
        }
    }
}

